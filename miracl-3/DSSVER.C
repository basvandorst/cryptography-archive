/*
 *   Proposed Digital Signature Standard (DSS)
 *
 *   See Communications ACM July 1992, Vol. 35 No. 7
 *   This new standard for digital signatures has been proposed by 
 *   the American National Institute of Standards and Technology (NIST)
 *   under advisement from the National Security Agency (NSA). 
 *
 *   This program verifies a the signature given to a <file> in
 *   <file>.dss generated by program dssign.c
 * 
 *   This program must be linked to functions in shs.c
 *
 *   Copyright (c) 1988-1993 Shamus Software Ltd.
 */

#include <stdio.h>
#include <miracl.h>
#include <stdlib.h>
#include <string.h>

void strip(name)
char name[];
{ /* strip off filename extension */
    int i;
    for (i=0;name[i]!='\0';i++)
    {
        if (name[i]!='.') continue;
        name[i]='\0';
        break;
    }
}

static void hashing(fp,hash)
FILE *fp;
big hash;
{ /* compute hash function */
    unsigned char h[20];
    int i,ch;
    shs_init();
    while ((ch=fgetc(fp))!=EOF) shs_process(ch);
    shs_hash(h);
/* convert to big number */
    INPLEN=20;
    instr(hash,h);
}

main()
{
    FILE *fp;
    char ifname[13],ofname[13];
    big p,q,g,y,v,u1,u2,r,s,t,hash;
    mirsys(200,256);
    p=mirvar(0);
    q=mirvar(0);
    g=mirvar(0);
    y=mirvar(0);
    v=mirvar(0);
    u1=mirvar(0);
    u2=mirvar(0);
    s=mirvar(0);
    r=mirvar(0);
    t=mirvar(0);
    hash=mirvar(0);
/* get public data */
    fp=fopen("common.dss","r");
    if (fp==NULL)
    {
        printf("file common.dss does not exist\n");
        exit(0);
    }
    cinnum(q,fp);
    cinnum(p,fp);
    cinnum(g,fp);
    fclose(fp);

/* get public key of recipient */
    fp=fopen("public.dss","r");
    if (fp==NULL)
    {
        printf("file public.dss does not exist\n");
        exit(0);
    }
    cinnum(y,fp);
    fclose(fp);
/* get message */
    printf("signed file = ");
    gets(ifname);
    strcpy(ofname,ifname);
    strip(ofname);
    strcat(ofname,".dss");
    if ((fp=fopen(ifname,"rb"))==NULL)
    { /* no message */
        printf("Unable to open file %s\n",ifname);
        exit(0);
    }
    hashing(fp,hash);
    fclose(fp);
    fp=fopen(ofname,"r");
    if (fp==NULL)
    { /* no signature */
        printf("signature file %s does not exist\n",ofname);
        exit(0);
    }
    cinnum(r,fp);
    cinnum(s,fp);
    fclose(fp);
    if (compare(r,q)>=0 || compare(s,q)>=0)
    {
        printf("Signature is NOT verified\n");
        exit(0);
    }
    xgcd(s,q,s,s,s);
    mad(hash,s,s,q,q,u1);
    mad(r,s,s,q,q,u2);
    powmod(g,u1,p,t);
    powmod(y,u2,p,v);
    mad(t,v,v,p,p,v);
    divide(v,q,q);
    if (compare(v,r)==0) printf("Signature is verified\n");
    else                 printf("Signature is NOT verified\n");
}

