Path: msuinfo!agate!darkstar.UCSC.EDU!news.hal.COM!olivea!sgigate.sgi.com!sgiblab!sdd.hp.com!math.ohio-state.edu!howland.reston.ans.net!swiss.ans.net!solaris.cc.vt.edu!uunet!george.inhouse.compuserve.com!news.inhouse.compuserve.com!compuserve.com!news
From: Bob Jenkins <74512.261@CompuServe.COM>
Newsgroups: sci.crypt
Subject: Failing the gap test
Date: 9 Sep 1994 06:19:30 GMT
Organization: via CompuServe Information Service
Lines: 45
Message-ID: <34oupi$psm$1@mhade.inhouse.compuserve.com>


A few months ago I was building random number generators.  A lot
of them failed Knuth's gap test.  How do they fail?  Usually they do
fine for small gaps, then for some medium size gap there's suddenly a 
spike.  The gap is much more or much less likely than it should be.
This happens in delayed Fibonacci and add-with-carry generators as 
well.  Very annoying.

So WHY do they fail?  Well, it's almost always the same thing:
  g(i) = i + f(i) mod N   
where f is a permutation of 0..N-1.  Consider: Is there any 
permutation f for which i+f(i) is also a permutation?

  sum_{i=0}^{N-1}{i     } mod N = N(N-1)/2 mod N
                                = N/2  if N is even
                                  or 0 if N is odd

  sum_{i=0}^{N-1}{  f(i)} mod N = N(N-1)/2 mod N
                                = N/2  if N is even
                                  or 0 if N is odd

  sum_{i=0}^{N-1}{i+f(i)} mod N = N(N-1)   mod N
                                = 0    whether N is even or odd.

If N is even, there is no permutation f such that i+f(i) is a
permutation.  (If N is odd, f(i) = c*i mod N is a permutation if
c and N are relatively prime, so is i+f(i) if c-1 and N are r.p.)
If it isn't a permutation, then the results will favor some values
more than others, hence it is biased.  For example, N=2:

  g(0) = 0+0 mod 2 = 0     or     g(0) = 0+1 mod 2 = 1   
  g(1) = 1+1 mod 2 = 0            g(1) = 1+0 mod 2 = 1

Usually it isn't direct like that.  More common is
  x = m[i] + f(m[j])
where m has L terms and i,j are in 0..L-1.  All terms are 
independent, but 1/L of the time i==j and the bias appears.

Even that is too direct.  What really happens is a bias is
detected in x=i+f(j+f(k+f(i))) on the condition i<>k+f(i) and
i<>j+f(k+f(i)).  There's some gap at which i is always fed back
in, and you get a spike right there in the gap test.

                       - Bob Jenkins
                       74512.261@CompuServe.COM
